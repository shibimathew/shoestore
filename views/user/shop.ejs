
<%- include("../../views/partials/user/header") %>

<header class="header-area header-style-1 header-height-2">
    <div class="header-top header-top-ptb-1 d-none d-lg-block">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-xl-3 col-lg-4">
                    <div class="header-info">
                        <ul>
                            <li><i class="fi-rs-smartphone"></i> <a href="#">(+01) - 2345 - 6789</a></li>
                            <li><i class="fi-rs-marker"></i><a href="/contact">Our location</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-xl-6 col-lg-4">
                    <div class="text-center">
                    </div>
                </div>
                <div class="col-xl-3 col-lg-4">
                    <div class="header-info header-info-right">
                        <ul>
                            <li>
                                <a class="language-dropdown-active" href="#"> <i class="fi-rs-world"></i> English <i class="fi-rs-angle-small-down"></i></a>
                                <ul class="language-dropdown">
                                    <li><a href="#"><img src="assets/imgs/theme/flag-fr.png" alt="">Français</a></li>
                                    <li><a href="#"><img src="assets/imgs/theme/flag-dt.png" alt="">Deutsch</a></li>
                                    <li><a href="#"><img src="assets/imgs/theme/flag-ru.png" alt="">Pусский</a></li>
                                </ul>
                            </li>
                            <% if (locals.user) { %>
                                <div class="dropdown">
                                    <a href="#" class="sign-in-link"><%= locals.user.name %></a>
                                    <div class="dropdown-content">
                                        <a href="/profileinfo">Profile</a>
                                        <!-- <a href="/orders">Orders</a> -->
                                        <a href="/logout">Logout</a>
                                    </div>
                                </div>
                            <% } else { %>
                                <li>
                                    <div class="d-flex gap-2">
                                        <a href="/login" class="btn btn-sm btn-outline-primary">Login</a>
                                        <a href="/signup" class="btn btn-sm btn-primary">Sign Up</a>
                                    </div>
                                </li>
                            <% } %>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="header-middle header-middle-ptb-1 d-none d-lg-block">
        <div class="container">
            <div class="header-wrap">
                <div class="logo logo-width-1">
                    <img src="/assets/imgs/theme/shoestore-logo.svg" alt="Shoestore Logo">
                </div>
                <div class="header-right">
                    <!-- <div class="search-style-2">
                        <form action="#">
                            <input type="text" placeholder="Search for items...">
                        </form>
                    </div> -->
                    <div class="header-action-right">
                        <div class="header-action-2">
                            <div class="header-action-icon-2">
                                <a href="/wishlist">
                                    <img class="svgInject" alt="Evara" src="assets/imgs/theme/icons/icon-heart.svg">
                                    <!-- <span class="pro-count blue">4</span> -->
                                </a>
                            </div>
                            <div class="header-action-icon-2">
                                <a class="mini-cart-icon" href="/cart">
                                    <img alt="Evara" src="assets/imgs/theme/icons/icon-cart.svg">
                                    <!-- <span class="pro-count blue">2</span> -->
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="header-bottom header-bottom-bg-color sticky-bar">
        <div class="container">
            <div class="header-wrap header-space-between position-relative">
                <div class="logo logo-width-1 d-block d-lg-none">
                    <a href="/home"><img src="/assets/imgs/theme/shoestore-logo.svg" alt="Shoestore Logo"></a>
                </div>
                <div class="header-nav d-none d-lg-flex">
                    <div class="main-menu main-menu-padding-1 main-menu-lh-2 d-none d-lg-block">
                        <nav>
                            <ul>
                                <li><a href="/home">Home</a></li>
                                <li><a href="#">About</a></li>
                                <li><a class="active" href="/shop">Shop</a></li>
                                <li class="position-static"><a href="#">Deals</a></li>
                                <li><a href="page-contact.html">Contact</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
                <div class="hotline d-none d-lg-block">
                    <p><i class="fi-rs-headset"></i><span>Hotline</span> 1900 - 888 </p>
                </div>   
            </div>
        </div>
    </div>
</header>

<style>
 .main-container {
   max-width: 1200px;
   margin: 0 auto;
   padding: 20px;
 }
 .shop-topbar {
   display: flex;
   justify-content: space-between;
   align-items: center;
   margin-bottom: 20px;
 }
 .search-form {
   display: flex;
   align-items: center;
   background-color: #f1f1f1;
   border-radius: 25px;
   overflow: hidden;
   max-width: 250px;
   box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
 }
 .search-input {
   flex: 1;
   padding: 8px 10px;
   font-size: 14px;
   border: none;
   outline: none;
   background-color: transparent;
 }
 .search-button {
   padding: 8px 15px;
   background-color: #1e918b;
   color: #fff;
   border: none;
   cursor: pointer;
   font-size: 14px;
   border-radius: 15px;
   margin-right: 5px;
   transition: background-color 0.3s, transform 0.2s;
 }
 .search-button:hover {
   background-color: #0056b3;
   transform: scale(1.05);
 }
 .sidebar {
   padding: 20px;
   border: 1px solid #ddd;
   background-color: #f9f9f9;
   border-radius: 8px;
   margin-bottom: 20px;
   width: 250px;
   text-align: center;
 }
 .filter-section {
   margin-bottom: 20px;
 }
 .filter-title {
   font-weight: bold;
   margin-bottom: 10px;
   font-size: 16px;
   color: #333;
 }
 .filter-item {
   margin: 5px 0;
 }
 .filter-item a {
   color: #333;
   text-decoration: none;
   padding: 8px 15px;
   display: block;
   transition: all 0.3s ease;
 }
 .filter-item a:hover,
 .filter-item a.active {
   background-color: #007bff;
   color: white;
   border-radius: 4px;
 }
 .product-list-container {
   display: flex;
   gap: 20px;
 }
 .product-grid {
   display: flex;
   flex-wrap: wrap;
   gap: 20px;
   width: calc(100% - 270px);
 }
 .product-card {
   width: calc(33.333% - 20px);
   border: 1px solid #ddd;
   padding: 15px;
   border-radius: 8px;
   text-align: center;
   position: relative;
   max-height: 350px;
 }
 .product-card img {
   max-width: 100%;
   height: auto;
   border-radius: 5px;
 }
 .wishlist-btn {
   position: absolute;
   top: 8px;
   right: 8px;
   background-color: rgba(237, 247, 247, 0.8);
   color: #fff;
   padding: 8px;
   border-radius: 50%;
   cursor: pointer;
 }
 .add-to-cart-btn {
   background-color: #46698f;
   color: #fff;
   padding: 10px;
   border: none;
   border-radius: 5px;
   cursor: pointer;
   width: 100%;
   margin-top: 10px;
 }
 .pagination {
   display: flex;
   justify-content: center;
   gap: 10px;
   margin: 20px 0;
 }
 .pagination a {
   padding: 8px 12px;
   background-color: #f0f0f0;
   border: 1px solid #ddd;
   color: #333;
   text-decoration: none;
 }
 .pagination .active {
   background-color: #007bff;
   color: #fff;
 }
 .price-filter {
   padding: 10px;
   background-color: #f9f9f9;
   border-radius: 8px;
   margin-top: 20px;
 }
 .price-options {
   display: flex;
   flex-direction: column;
   gap: 10px;
 }
 .price-button {
   padding: 12px 20px;
   background-color: #f1f1f1;
   color: #333;
   border: 1px solid #ddd;
   border-radius: 30px;
   cursor: pointer;
   transition: background-color 0.3s, transform 0.2s;
   text-align: center;
   font-size: 14px;
   width: 100%;
 }
 .price-button:hover,
 .price-button.active {
   background-color: #007bff;
   color: white;
   transform: scale(1.05);
 }
 .price-button:active {
   transform: scale(0.95);
 }
 .category-brand-container {
   text-align: center;
 }
 .sort-filter {
   padding: 10px;
   background-color: #f9f9f9;
   border-radius: 8px;
   margin-top: 20px;
 }
 .sort-options {
   display: flex;
   flex-direction: column;
   gap: 10px;
 }
 .sort-button {
   padding: 12px 20px;
   background-color: #f1f1f1;
   color: #333;
   border: 1px solid #ddd;
   border-radius: 30px;
   cursor: pointer;
   transition: background-color 0.3s, transform 0.2s;
   text-align: center;
   font-size: 14px;
   width: 100%;
 }
 .sort-button:hover,
 .sort-button.active {
   background-color: #007bff;
   color: white;
   transform: scale(1.05);
 }
 .sort-button:active {
   transform: scale(0.95);
 }
 .dropdown{
   position:relative;
   display:inline-block;
 }
 .dropdown-content{
   display: none;
   position: absolute;
   background-color: white;
   min-width: 160px;
   box-shadow: 0px 8px 16px 0px rgb(0,0,0,0,2);
   z-index: 1000;
   right: 0;
 }
 .dropdown-content a {
   color: black;
   padding: 12px 16px;
   text-decoration: none;
   display: block;
   width: 100%;
 }
 .dropdown-content a:hover{
   background-color: #f1f1f1;
 }
 .dropdown:hover .dropdown-content{
   display:block;
 }
 .header {
   position: relative;
   z-index: 500;
 }

 @media (max-width : 769px){
   .product-card {
   width: 180px;
   border: 1px solid #ddd;
   padding: 15px;
   border-radius: 8px;
   text-align: center;
   position: relative;
   max-height: 250px;
   max-width: 200px;
 }
 }

</style>

<div class="main-container">
 <section class="shop-page container">
   <div class="shop-topbar">
     <div class="search-bar">
       <form action="/search" method="POST" class="search-form">
         <input type="text" name="query" placeholder="Search items..." class="search-input" />
         <button type="submit" class="search-button">Search</button>
       </form>
     </div>
   </div>
  
   <div class="product-list-container">
     <aside class="sidebar">
       <div class="filter-section">
         <div class="filter-title">Categories</div>
         <ul>
           <% for(let i = 0; i < category.length; i++) { %>
             <li class="filter-item">
               <a href="/filter?category=<%= category[i]._id %>&sort=<%= currentSort || 'newest' %>" 
                  class="<%= selectedCategory === category[i]._id.toString() ? 'active' : '' %>">
                 <%= category[i].name %>
               </a>
             </li>
           <% } %>
         </ul>
       </div>

       <div class="price-filter">
         <div class="filter-title">Filter by Price</div>
         <form id="price-filter-form">
           <div class="price-options">
             <a href="/filterPrice?gt=0&lt=500&category=<%= selectedCategory || '' %>&sort=<%= currentSort || 'newest' %>">
               <button type="button" class="price-button <%= priceRange && priceRange.gt === '0' && priceRange.lt === '500' ? 'active' : '' %>">Under ₹500</button>
             </a>
             <a href="/filterPrice?gt=500&lt=1000&category=<%= selectedCategory || '' %>&sort=<%= currentSort || 'newest' %>">
               <button type="button" class="price-button <%= priceRange && priceRange.gt === '500' && priceRange.lt === '1000' ? 'active' : '' %>">₹500 - ₹1000</button>
             </a>
             <a href="/filterPrice?gt=1000&lt=1500&category=<%= selectedCategory || '' %>&sort=<%= currentSort || 'newest' %>">
               <button type="button" class="price-button <%= priceRange && priceRange.gt === '1000' && priceRange.lt === '1500' ? 'active' : '' %>">₹1000- ₹1500</button>
             </a>
             <a href="/filterPrice?gt=1500&lt=20000&category=<%= selectedCategory || '' %>&sort=<%= currentSort || 'newest' %>">
               <button type="button" class="price-button <%= priceRange && priceRange.gt === '1500' && priceRange.lt === '20000' ? 'active' : '' %>">Above ₹1500</button>
             </a>
           </div>
         </form>
       </div>

       <!-- Add Sorting Section -->
       <div class="sort-filter">
         <div class="filter-title">Sort By</div>
         <form id="sort-form">
           <div class="sort-options">
             <a href="/shop?sort=price_asc&category=<%= selectedCategory || '' %>">
               <button type="button" class="sort-button <%= currentSort === 'price_asc' ? 'active' : '' %>">Price: Low to High</button>
             </a>
             <a href="/shop?sort=price_desc&category=<%= selectedCategory || '' %>">
               <button type="button" class="sort-button <%= currentSort === 'price_desc' ? 'active' : '' %>">Price: High to Low</button>
             </a>
             <a href="/shop?sort=name_asc&category=<%= selectedCategory || '' %>">
               <button type="button" class="sort-button <%= currentSort === 'name_asc' ? 'active' : '' %>">Name: A to Z</button>
             </a>
             <a href="/shop?sort=name_desc&category=<%= selectedCategory || '' %>">
               <button type="button" class="sort-button <%= currentSort === 'name_desc' ? 'active' : '' %>">Name: Z to A</button>
             </a>
             <a href="/shop?sort=newest&category=<%= selectedCategory || '' %>">
               <button type="button" class="sort-button <%= currentSort === 'newest' ? 'active' : '' %>">Newest First</button>
             </a>
           </div>
         </form>
       </div>
     </aside>

     <main class="product-grid">
       <% products.forEach(function(product) { %>
        
         <div class="product-card">
           <span class="wishlist-btn" onclick="">❤️</span>
          
            <a href="/productDetails?id=<%= product.id || product._id %>">
             <img src="<%= product.images[0] %>" alt="<%= product.productName %>" />
             <h4><%= product.productName %></h4>
          <p>
  <% let price = product.salePrice 
    let productOffer = product.productOffer
    let salePrice = price - (price * (productOffer/100))
  %>
   Price: ₹<%= Number(salePrice).toLocaleString('en-IN') %>
   <span class="text-muted">
     <strike>₹<%= Number(product.regularPrice).toLocaleString('en-IN') %></strike>
   </span>
 </p>
           </a>
           <!-- <button class="add-to-cart-btn" onclick="">Add to Cart</button> -->
         </div>
       <% }); %>
     </main>
   </div>

   <!-- Pagination -->
   <div class="pagination">
     <% if (currentPage > 1) { %>
       <a class="btn" href="/shop?page=<%= currentPage - 1 %>">Prev</a>
     <% } %>

     <% for (let i = 1; i <= totalPages; i++) { %>
       <a class="btn <%= currentPage === i ? 'active' : '' %>" href="/shop?page=<%= i %>"><%= i %></a>
     <% } %>

     <% if (currentPage < totalPages) { %>
       <a class="btn" href="/shop?page=<%= currentPage + 1 %>">Next</a>
     <% } %>
   </div>
 </section>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get current sort parameter from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentSort = urlParams.get('sort');
    
    // Add active class to current sort button
    if (currentSort) {
        const sortButton = document.querySelector(`a[href="/shop?sort=${currentSort}"] button`);
        if (sortButton) {
            sortButton.classList.add('active');
        }
    }
});
// Add this script to your shop page or include it in your main JS file

document.addEventListener('DOMContentLoaded', function() {
    // Handle wishlist button clicks
    document.querySelectorAll('.wishlist-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const productCard = this.closest('.product-card');
            const productLink = productCard.querySelector('a[href*="productDetails"]');
            const href = productLink.getAttribute('href');
            
            // Extract product ID from the URL
            const urlParams = new URLSearchParams(href.split('?')[1]);
            const productId = urlParams.get('id');
            
            if (!productId) {
                showNotification('Product ID not found', 'error');
                return;
            }
            
            // Check if product is already in wishlist
            const isInWishlist = this.classList.contains('in-wishlist');
            
            if (isInWishlist) {
                removeFromWishlist(productId, this);
            } else {
                addToWishlist(productId, this);
            }
        });
    });
    
    // Get current sort parameter from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentSort = urlParams.get('sort');
    
    // Add active class to current sort button
    if (currentSort) {
        const sortButton = document.querySelector(`a[href="/shop?sort=${currentSort}"] button`);
        if (sortButton) {
            sortButton.classList.add('active');
        }
    }
    
    // Load wishlist status for products on page load
    loadWishlistStatus();
});

// Function to add product to wishlist
function addToWishlist(productId, buttonElement) {
    fetch('/wishlist/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ productId: productId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message === 'Product added to wishlist successfully') {
            buttonElement.classList.add('in-wishlist');
            buttonElement.style.color = '#ff6b6b';
            buttonElement.title = 'Remove from wishlist';
            showNotification('Added to wishlist!', 'success');
            updateWishlistCount(data.totalCount);
        } else if (data.message === 'Product already in wishlist') {
            buttonElement.classList.add('in-wishlist');
            buttonElement.style.color = '#ff6b6b';
            showNotification('Product already in wishlist', 'info');
        } else {
            showNotification(data.message || 'Error adding to wishlist', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error adding to wishlist', 'error');
    });
}

// Function to remove product from wishlist
function removeFromWishlist(productId, buttonElement) {
    fetch('/wishlist/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ productId: productId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message === 'Removed from wishlist') {
            buttonElement.classList.remove('in-wishlist');
            buttonElement.style.color = '#ccc';
            buttonElement.title = 'Add to wishlist';
            showNotification('Removed from wishlist!', 'success');
            updateWishlistCount(data.totalCount);
        } else {
            showNotification(data.message || 'Error removing from wishlist', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error removing from wishlist', 'error');
    });
}

// Function to load wishlist status for all products on the page
function loadWishlistStatus() {
    const productCards = document.querySelectorAll('.product-card');
    const productIds = [];
    
    productCards.forEach(card => {
        const productLink = card.querySelector('a[href*="productDetails"]');
        if (productLink) {
            const href = productLink.getAttribute('href');
            const urlParams = new URLSearchParams(href.split('?')[1]);
            const productId = urlParams.get('id');
            if (productId) {
                productIds.push(productId);
            }
        }
    });
    
    if (productIds.length === 0) return;
    
    // Fetch wishlist status for all products
    fetch('/wishlist/status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ productIds: productIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.wishlistItems) {
            data.wishlistItems.forEach(productId => {
                const productCard = findProductCardById(productId);
                if (productCard) {
                    const wishlistBtn = productCard.querySelector('.wishlist-btn');
                    if (wishlistBtn) {
                        wishlistBtn.classList.add('in-wishlist');
                        wishlistBtn.style.color = '#ff6b6b';
                        wishlistBtn.title = 'Remove from wishlist';
                    }
                }
            });
        }
    })
    .catch(error => {
        console.error('Error loading wishlist status:', error);
    });
}

// Helper function to find product card by ID
function findProductCardById(productId) {
    const productCards = document.querySelectorAll('.product-card');
    for (let card of productCards) {
        const productLink = card.querySelector('a[href*="productDetails"]');
        if (productLink) {
            const href = productLink.getAttribute('href');
            const urlParams = new URLSearchParams(href.split('?')[1]);
            const id = urlParams.get('id');
            if (id === productId) {
                return card;
            }
        }
    }
    return null;
}

// Function to show notifications
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    // Style the notification
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 4px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;
    
    // Set background color based on type
    switch(type) {
        case 'success':
            notification.style.backgroundColor = '#28a745';
            break;
        case 'error':
            notification.style.backgroundColor = '#dc3545';
            break;
        case 'info':
            notification.style.backgroundColor = '#17a2b8';
            break;
        default:
            notification.style.backgroundColor = '#6c757d';
    }
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Function to update wishlist count in navbar
function updateWishlistCount(count) {
    const wishlistCountElement = document.querySelector('.wishlist-count');
    if (wishlistCountElement) {
        wishlistCountElement.textContent = count;
    }
}
</script>

<%- include("../../views/partials/user/footer") %>